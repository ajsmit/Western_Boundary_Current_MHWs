---
title: "Model fitting"
author:
- affiliation: University of the Western Cape
  name: AJ Smit
date: "26 February 2017"
output:
  bookdown::html_document2:
    fig_caption: yes
    fig_retina: 2
    fig_width: 7
    highlight: espresso
    theme: sandstone
    toc_float: no
  html_document:
    fig_caption: yes
    fig_retina: 2
    fig_width: 7
    highlight: espresso
    theme: sandstone
    toc_float: no
  bookdown::pdf_document2:
    fig_caption: yes
    fig_height: 6.5
    fig_width: 6.5
    highlight: default
    keep_tex: yes
    latex_engine: xelatex
    template: /Users/ajsmit/Dropbox/repos/templates/template-article_ajs.tex
  word_document:
    fig_caption: yes
    fig_height: 7
    fig_width: 7
    highlight: zenburn
    toc: no
fontsize: 10pt
geometry: margin=1in
language: Australian
mainfont: Minion Pro
monofont: Myriad Pro
csl: /Users/ajsmit/Dropbox/repos/csl/plos.csl
papersize: A4
sansfont: Myriad Pro
tables: yes
bibliography: /Users/ajsmit/Dropbox/repos/bibliography/bibliography.bib
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(include = FALSE, echo = FALSE, warning = FALSE,
                      message = FALSE, tidy = FALSE, cache = TRUE,
                      fig.align = 'left', fig.show = 'hold',
                      fig.path = 'figures/OISST-')
```

```{r load-pkg, include = FALSE}
library(RmarineHeatWaves)
library(data.table)
library(plyr)
library(tidyverse)
library(lubridate)
library(forcats)
library(mgcv)
library(broom)
library(doMC); doMC::registerDoMC(cores = 4)
library(ggpubr); theme_set(theme_pubr())
source("functions.R")
```

# Some functions
```{r fast-date-fun}
# a fast date function
fastDate <- function(x, tz = NULL) {
  require(fasttime)
  as.Date(fastPOSIXct(x, tz = tz))
}

source("/Users/ajsmit/Dropbox/repos/Ocean_MHW/Changing_nature_of_ocean_heat/functions/models.R")
```


# Import the data and set-up

## Import and make whole

```{r data-setup}
# recode factors and create mean of replicate 'in' and 'out' regions within each current, etc.
sst.in <- as.tibble(fread("/Volumes/Benguela/spatial/processed/OISSTv2/WBC/subregions/all-sub-avhrr-only-v2.19810901-20171019.csv"))
sst <- sst.in %>%
  mutate(t = fastDate(t)) %>%
  mutate(location = fct_recode(ID,
                          "in" = "sub1",
                          "in" = "sub2",
                          "in" = "sub3",
                          "out" = "sub4",
                          "out" = "sub5",
                          "out" = "sub6")) %>%
  group_by(t, region, location) %>%
  dplyr::summarise(temp = mean(temp, na.rm = TRUE)) %>%
  ungroup()
remove(sst.in)
```

## Detect events and calculate the climatologies
```{r make-MHW-fun}
# daily data - make whole
sst.d <- as.tibble(ddply(sst, .(region, location), make_whole, .parallel = TRUE)) %>% 
  dplyr::group_by(region, location) %>% 
  nest()

# detect events for each of the regions and 'in' and 'out' groups
detect.ev <- function(sst) {
  out <- RmarineHeatWaves::detect(sst[, 1:3], min_duration = 5, max_gap = 2, cold_spells = FALSE,
                                  climatology_start = "1983-01-01", climatology_end = "2012-12-31")
  x <- out$event
  return(x)
  }

make.clm <- function(sst) {
  out <- RmarineHeatWaves::detect(sst[, 1:3], min_duration = 5, max_gap = 2, cold_spells = FALSE,
                                  climatology_start = "1983-01-01", climatology_end = "2012-12-31")
  x <- out$clim[, 1:5]
  return(x)
}

# detect events and create climatology for each of the regions and 'in' and 'out' groups
ev <- sst.d %>%
  dplyr::mutate(ev = map(data, detect.ev)) %>% 
  unnest(ev)

clm <- sst.d %>%
  dplyr::mutate(clm = map(data, make.clm)) %>% 
  unnest(clm)
```

## Prepare daily data
We can fit directly using the daily data already prepared. 

```{r climatology-nest}
# prepare a nested tibble with a column containing the 'de-seasoned' data and 
# region-specific anomalies
daily.dat <- clm %>%
  mutate(de.seas = temp - seas_clim_year) %>%
  group_by(region, location) %>%
  mutate(anom = temp - mean(temp, na.rm = TRUE),
         num = seq(1:length(temp))) %>%
  nest()
```

## Prepare monthly data
First I need to calculate the monthly seasonal trend to remove from the monthly data, below. Rather than using a GAM to produce a seasonal climatology, I use the one already made by **RmarineHeatWaves** `detect()`. I simply average these within each month of the year. A consequence of doing this is that I now do not have to account for a cyclic seasonal component in the GAMMs using cyclic cubic spline, as seasonality has now entirely been removed. Instead, the following models will focus on the longer-term variations remaining within the data, and account for serial dependence of the residuals using autoregressive parameters. There are two choices: i) using a correlation structure, `form = ~ 1|Year`, allows ARMA to be nested within each year; ii) ...

```{r seasonal-climatological-anomaly}

seas.anom <- clm %>%
  dplyr::mutate(date = floor_date(date, unit = "month")) %>%
  dplyr::group_by(region, location, date) %>%
  dplyr::summarise(seas_clim_year = mean(seas_clim_year, na.rm = TRUE)) %>%
  dplyr::group_by(region, location) %>%
  dplyr::mutate(seas.anom = seas_clim_year - mean(seas_clim_year, na.rm = TRUE)) %>%
  dplyr::ungroup() %>%
  dplyr::select(seas.anom) %>%
  as.data.frame()

# monthly (sst.d to monthly.dat) with columns containing anomalies
sst.x <- sst.d %>%
  unnest(data) %>% 
  dplyr::mutate(date = floor_date(date, unit = "month")) %>%
  dplyr::mutate(year = year(date)) %>%
  dplyr::group_by(region, location, date, year) %>%
  dplyr::summarise(temp = mean(temp, na.rm = TRUE)) %>%
  dplyr::group_by(region, location) %>%
  dplyr::mutate(anom = temp - mean(temp, na.rm = TRUE)) %>%
  dplyr::mutate(num = seq(1:length(temp))) %>%
  dplyr::mutate(nMonth = month(date)) %>%
  dplyr::mutate(time = as.numeric(date) / 1000) %>% 
  dplyr::ungroup() %>%
  as.data.frame()

monthly.x <- as.tibble(cbind(sst.x, seas.anom))
monthly.dat <- monthly.x %>%
  dplyr::mutate(de.seas = anom - seas.anom) %>%
  dplyr::group_by(region, location) %>%
  nest()
```

# Model fitting
Now we fit various flavours of Generalised Additive Models (GAMs) and Generalised Additive Mixed Models (GAMMs).
1. omit fitting a GAM to the 'raw' data
2. fit GAM to de-seasoned data (raw minus climatology)
3. plot them all

## daily, GAM
```{r map-mods1}
# function for GAM to fit to de-seasoned daily data
# setting k = 20 ensures a good visual fit of the line
gam.fun <- function(df) {
  gam(de.seas ~ s(num, k = 20), data = df)
}

# fit models and add into new columns
gams.1 <- daily.dat %>%
  dplyr::mutate(mod.gam = map(data, gam.fun))

gams.1 <- gams.1 %>%
  dplyr::mutate(out = map2(mod.gam, data, ~ augment(.x))) %>% 
  unnest(data, out)
```

```{r}
sst.d2 <- gams.1 %>% 
  dplyr::select(region, location, doy, date, .resid) %>% 
  dplyr::rename(temp = .resid) %>% 
  dplyr::group_by(region, location) %>% 
  nest()

ev2 <- sst.d2 %>%
  dplyr::mutate(ev = map(data, detect.ev)) %>% 
  unnest(ev)
```

```{r plot-daily-mods, include = TRUE}
gams.1 %>%
  # unnest(data, predict_gam) %>%
  ggplot(aes(x = date, y = de.seas, group = location)) +
  geom_hline(aes(yintercept = 0), size = 0.4) +
  geom_line(aes(colour = location), size = 0.1, alpha = 0.8) +
  geom_line(aes(y = .fitted, colour = location), alpha = 1.0, size = 0.75) +
  facet_grid(region ~ .) +
  scale_colour_manual(values = c("red3", "blue3")) +
  labs(x = "Date", y = "Temperature anomaly (°C)",
       title = "Generalised Additive Model -- daily data")
# ggplot2::ggsave("../figures/Fig13_dailyGam.pdf", width = 8.25, height = 5, scale = 1.1)

# the detrended daily data
gams.1 %>%
  # unnest(data, predict_gam) %>%
  ggplot(aes(x = date, y = .resid, group = location)) +
  geom_hline(aes(yintercept = 0), size = 0.4) +  
  geom_line(aes(colour = location), size = 0.1, alpha = 0.8) +
  geom_rug(data = filter(ev2, location == "in"),
           aes(x = date_start, y = int_max_abs), col = "red", sides = "b") +
  geom_rug(data = filter(ev2, location == "out"),
           aes(x = date_start, y = int_max_abs), col = "blue", sides = "t") +
  facet_grid(region ~ .) +
  scale_colour_manual(values = c("red3", "blue3")) +
  labs(x = "Date", y = "Temperature anomaly (°C)",
       title = "Generalised Additive Model -- daily data")
# ggplot2::ggsave("../figures/Fig13_dailyGam.pdf", width = 8.25, height = 5, scale = 1.1)

```

## Monthly, GAM
```{r map-mods2}
# fit models and add into new columns
gam.df <- monthly.dat %>%
  mutate(mod.gam = map(data, gam.fun))

gam.df <- gam.df %>%
  mutate(predicted = map2(mod.gam, data, ~ augment(.x, newdata = .y))) %>% 
  unnest(predicted)

gam.df %>%
  # unnest(data, predict_gam) %>%
  ggplot(aes(x = date, y = de.seas, group = location)) +
  geom_hline(aes(yintercept = 0), size = 0.4) +  
  geom_line(aes(colour = location), size = 0.2, alpha = 0.8) +
  geom_line(aes(y = .fitted, colour = location), alpha = 1.0, size = 0.55) +
  facet_grid(region ~ .) +
  scale_colour_manual(values = c("red3", "blue3")) +
  labs(x = "Date", y = "Temperature anomaly (°C)",
       title = "Generalised Additive Model -- monthly data")
# ggplot2::ggsave("../figures/Fig13_dailyGam.pdf", width = 8.25, height = 5, scale = 1.1)
```

## Monthly de-seasoned, GAMM (AR1)
```{r map-GAMM-AR1, include = TRUE}
# a gamm function: AR1
gamm.fun <- function(df, p = p) {
  ctrl <- list(niterEM = 0, msVerbose = FALSE, optimMethod = "BFGS")
  out <- gamm(de.seas ~ s(num, k = 20), data = df,
              correlation = corCAR1(form = ~ num),
              control = ctrl, verbosePQL = FALSE)
  return(out$gam)
}

# this one is a tensor product of year and month, with the AR1 correlation structure
gamm.fun2 <- function(df) {
  ctrl <- list(niterEM = 0, msVerbose = FALSE, optimMethod = "L-BFGS-B")
  out <- gamm(de.seas ~ te(year, nMonth, bs = c("cr", "cc")), data = df,
              correlation = corCAR1(form = ~ num),
              control = ctrl, verbosePQL = FALSE)
return(out$gam)
}

# fit the GAMM
gamms.AR1 <- monthly.dat %>%
  dplyr::mutate(mod.gamm = map(data, gamm.fun))

# massage the thing into something useful
fitted.AR1 <- as.data.frame(melt(mapply(function(x) gamms.AR1$mod.gamm[[x]]$fitted.values, 1:10))[3])
gamms.AR1.df <- as.tibble(cbind(unnest(monthly.dat, data), fitted.AR1))
gamms.AR1.df <- dplyr::rename(gamms.AR1.df, fitted = value)

# fit the GAMM
gamms.AR1 <- monthly.dat %>%
  dplyr::mutate(mod.gamm = map(data, gamm.fun))

gamms.AR1.df %>%
  ggplot(aes(x = date, y = de.seas)) +
  geom_hline(aes(yintercept = 0), size = 0.4) +    
  geom_line(aes(colour = location), size = 0.2, alpha = 1) +
  geom_line(aes(y = fitted, colour = location), alpha = 1.0, size = 0.55) +
  facet_grid(region ~ .) +
  scale_colour_manual(values = c("red3", "blue3")) +
  labs(x = "Date", y = "Temperature anomaly (°C)",
       title = "Generalised Additive Mixed Model (AR1) -- monthly means")
# ggplot2::ggsave("Changing_nature_of_ocean_heat/figures/Fig13_monthlyGAMM.pdf", width = 8.25, height = 5, scale = 0.8)
```

```{r monthly-GAM, include = TRUE}
# considering the GAMM does not capture the local features the way I would like it to, I am thinking
# about first removing the AR1 correlation from the time series, and then using the residuals 
# and fitting a GAM on that... i.e. remove the AR1 in the same way that the seasonal component
# was removed

# I'm using a GLS null model (for trend) for this
gls.fun <- function(df) {
  out <- gls(de.seas ~ 1, data = df, method = "REML", correlation = corAR1(form = ~ num))
  return(out)
}

# fit the GLS and keep the residuals
gls.AR1 <- monthly.dat %>%
  dplyr::mutate(mod.gls = map(data, gls.fun))

# massage the thing into something useful
residuals.AR1 <- as.data.frame(melt(mapply(function(x) gls.AR1$mod.gls[[x]]$residuals  , 1:10))[3])
gls.AR1.df <- as.tibble(cbind(unnest(monthly.dat, data), residuals.AR1))
gls.AR1.df <- dplyr::rename(gls.AR1.df, de.seas.corr = value)

gls.AR1.df <- gls.AR1.df %>% 
  dplyr::group_by(region, location) %>% 
  nest()

# a GAM to fit to the above residuals
gam.fun2 <- function(df) {
  gam(de.seas.corr ~ s(num, k = 20), data = df)
}

# fit models and add into new columns
gam.df2 <- gls.AR1.df %>%
  dplyr::mutate(mod.gam = map(data, gam.fun2))

gam.df2 <- gam.df2 %>%
  dplyr::mutate(out = map2(mod.gam, data, ~ augment(.x))) %>% 
  unnest(data, out)

# plot the de-seasoned series from which the AR1 correlation structure had been removed
plt.1a <- gam.df2 %>%
  ggplot(aes(x = date, y = de.seas.corr, group = location)) +
  # geom_vline(data = ev, aes(xintercept = date_start, colour = location), alpha = 0.1) +
  geom_hline(aes(yintercept = 0), alpha = 0.7, size = 0.2) +
  geom_line(aes(colour = location), size = 0.15, alpha = 1) +
  geom_rug(data = filter(ev, location == "in"),
           aes(x = date_start, y = int_max_abs), col = "red", sides = "b") +
  geom_rug(data = filter(ev, location == "out"),
           aes(x = date_start, y = int_max_abs), col = "blue", sides = "t") +
  # geom_line(aes(y = de.seas), colour = "black", size = 0.2, alpha = 0.6) +
  geom_ribbon(aes(ymin = (.fitted - .se.fit), ymax = (.fitted + .se.fit), 
                  fill = location), alpha = 0.7) +
  # geom_line(aes(y = .fitted), colout = "black", alpha = 0.7, size = 0.55) +
  facet_grid(region ~ .) +
  scale_y_continuous(limits = c(-4, 4), breaks = c(-3, 0, 3)) +
  scale_colour_manual(values = c("red3", "blue3")) +
  scale_fill_manual(values = c("red3", "blue3")) +
  labs(x = "Date", y = "Temperature anomaly (°C)") + guides(fill = FALSE)

# plot plot the de-seasoned series, sans AR1 and trend
plt.2a <- gam.df2 %>%
  ggplot(aes(x = date, y = .resid, group = location)) +
  # geom_vline(data = ev, aes(xintercept = date_start, colour = location), alpha = 0.1) +
  geom_hline(aes(yintercept = 0), alpha = 0.7, size = 0.2) +
  geom_line(aes(colour = location), size = 0.15, alpha = 1) +
  geom_rug(data = filter(ev2, location == "in"),
           aes(x = date_start, y = int_max_abs), col = "red", sides = "b") +
  geom_rug(data = filter(ev2, location == "out"),
           aes(x = date_start, y = int_max_abs), col = "blue", sides = "t") +
  facet_grid(region ~ .) +
  scale_y_continuous(limits = c(-4, 4), breaks = c(-3, 0, 3)) +
  scale_colour_manual(values = c("red3", "blue3")) +
  labs(x = "Date", y = "Temperature anomaly (°C)")
```

```{r event-trends, include = TRUE}
ev <- ev %>% 
  dplyr::mutate(trt = rep("trend", length(date_start)))
ev2 <- ev2 %>% 
  dplyr::mutate(trt = rep("detrend", length(date_start)))
ev3 <- rbind(ev, ev2)

# calculte the number of warm events per annum
ev.cnt <- ev3 %>%
  dplyr::mutate(year = year(date_start)) %>%
  dplyr::select(-date_start, -date_stop, -date_peak) %>%
  dplyr::group_by(region, location, trt, year) %>%
  dplyr::summarise(y = n()) %>%
  dplyr::group_by(region, location, trt) %>% 
  nest()

linFun <- function(annualEvent, poissan = FALSE) {
  if (poissan) 
    mod <- glm(y ~ year, family = poisson(link = "log"), 
               data = annualEvent) 
  else 
    mod <- lm(y ~ year, data = annualEvent)
  return(mod)
  # trend <- data.frame(slope = summary(mod)$coefficients[2,1], pval = summary(mod)$coefficients[2,4])
  # trend <- summary(mod)$coefficients[2,c(1,4)]
  # trend$pbracket <- cut(trend$pval, breaks = c(0, 0.001, 0.01, 0.05, 1))
  # return(trend)
}

# fit models and add into new columns
ev.mod <- ev.cnt %>%
  dplyr::mutate(mod.ev = map(data, linFun))

ev.1.param <- ev.mod %>%
  dplyr::mutate(out = map(mod.ev, glance)) %>% 
  unnest(out)

ev.1 <- ev.mod %>%
  dplyr::mutate(out = map2(mod.ev, data, ~ augment(.x))) %>% 
  unnest(data, out)

plt.1b <- ev.1 %>% 
  filter(trt == "trend") %>% 
  ggplot(aes(x = year, y = y)) +
  geom_point(aes(colour = location), size = 0.4) +
  geom_line(aes(y = .fitted, colour = location)) +
  facet_grid(region ~ .) +
  scale_colour_manual(values = c("red3", "blue3")) +
  scale_y_continuous(breaks = c(0, 5, 10)) +
  labs(x = "Date", y = "Count") + theme(legend.position = "right")

plt.2b <- ev.1 %>% 
  filter(trt == "detrend") %>% 
  ggplot(aes(x = year, y = y)) +
  geom_point(aes(colour = location), size = 0.4) +
  geom_line(aes(y = .fitted, colour = location)) +
  facet_grid(region ~ .) +
  scale_colour_manual(values = c("red3", "blue3")) +
  scale_y_continuous(breaks = c(0, 5, 10)) +
  labs(x = "Date", y = "Count") + theme(legend.position = "right")
```

```{r, include = TRUE}
ggarrange(plt.1a + theme(legend.position = 'none'), 
          plt.1b, labels = "AUTO", ncol = 2, 
          align = 'v')
```

```{r, include = TRUE}
ggarrange(plt.2a + theme(legend.position = 'none'), 
          plt.2b, labels = "AUTO", ncol = 2, 
          align = 'hv')
```

Now I'll make plots of the fitten GAMs, with areas where significant changes is happening indicated.
```{r, include = TRUE, fig.height = 7, fig.width = 7}
source("/Users/ajsmit/Dropbox/repos/functions/Gavin_Simpson/derivFun.R")

# The next revision of the code must be a simultaneous interval for the spline:
# https://www.fromthebottomoftheheap.net/2016/12/15/simultaneous-interval-revisited/

# I used the 'raw' monthly data because the derive function expects the whole
# model ('gam' + 'lme' parts), which does not get calculated when I do it through broom
sigSlope <- function(df, mod) {
  want <- seq(1, length(mod$fitted.values), length.out = 200)
  pdat <- with(df, data.frame(num = num[want], date = date[want], nMonth = nMonth[want]))
  p2 <- predict(mod, newdata = pdat, type = "terms", se.fit = TRUE)
  pdat$p2 <- as.vector(p2$fit)
  pdat$se2 <- as.vector(p2$se.fit)
  df.res <- df.residual(mod)
  crit.t <- qt(0.025, df.res, lower.tail = FALSE)
  pdat$upper <- pdat$p2 + (crit.t * pdat$se2)
  pdat$lower <- pdat$p2 - (crit.t * pdat$se2)
  Term <- "num"
  d <- Deriv(mod)
  dci <- confint(d, term = Term)
  dsig <- signifD(pdat$p2, d = d[[Term]]$deriv, dci[[Term]]$upper, dci[[Term]]$lower)
  pdat$incr <- dsig$incr
  pdat$decr <- dsig$decr
  return(pdat)
  }

makePred <- function(region) {
  x <- gam.df2[gam.df2$region == region, ]
  in.gam <- gam(de.seas.corr ~ s(num, k = 20), data = filter(x, location == "in"))
  out.gam <- gam(de.seas.corr ~ s(num, k = 20), data = filter(x, location == "out"))
  in.pred <- sigSlope(filter(x, location == "in"), in.gam)
  in.pred$region <- rep(region, nrow(in.pred))
  in.pred$location <- rep("in", nrow(in.pred))
  out.pred <- sigSlope(filter(x, location == "out"), out.gam)
  out.pred$region <- rep(region, nrow(in.pred))
  out.pred$location <- rep("out", nrow(in.pred))
  pred <- rbind(in.pred, out.pred)
  ll <- list(data = x, predicted = pred)
  return(ll)
}

theme_set(theme_pubr())

AC.pred <- makePred("AC")

AC <- ggplot(data = AC.pred$predicted, aes(x = date, group = location)) +
  geom_line(data = AC.pred$data, aes(x = date, y = de.seas.corr, colour = location), 
            size = 0.2, show.legend = FALSE) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = "grey70", alpha = 0.7, show.legend = FALSE) +
  geom_hline(aes(yintercept = 0), colour = "black", linetype = "dotted") +
  geom_line(aes(y = incr), colour = "black", size = 0.5) +
  geom_line(aes(y = decr), colour = "black", size = 0.5) +
  facet_grid(location ~ .) +
  scale_color_manual(values = c("red3", "blue3")) +
  labs(x = "Date", y = "Temp. anom. (°C)") + ggtitle("Agulhas Current")

BC.pred <- makePred("BC")

BC <- ggplot(data = BC.pred$predicted, aes(x = date, group = location)) +
  geom_line(data = BC.pred$data, aes(x = date, y = de.seas.corr, colour = location), 
            size = 0.2, show.legend = FALSE) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = "grey70", alpha = 0.7, show.legend = FALSE) +
  geom_hline(aes(yintercept = 0), colour = "black", linetype = "dotted") +
  geom_line(aes(y = incr), colour = "black", size = 0.5) +
  geom_line(aes(y = decr), colour = "black", size = 0.5) +
  facet_grid(location ~ .) +
  scale_color_manual(values = c("red3", "blue3")) +
  labs(x = "Date", y = "Temp. anom. (°C)") + ggtitle("Brazil Current")

EAC.pred <- makePred("EAC")

EAC <- ggplot(data = EAC.pred$predicted, aes(x = date, group = location)) +
  geom_line(data = EAC.pred$data, aes(x = date, y = de.seas.corr, colour = location), 
            size = 0.2, show.legend = FALSE) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = "grey70", alpha = 0.7, show.legend = FALSE) +
  geom_hline(aes(yintercept = 0), colour = "black", linetype = "dotted") +
  geom_line(aes(y = incr), colour = "black", size = 0.5) +
  geom_line(aes(y = decr), colour = "black", size = 0.5) +
  facet_grid(location ~ .) +
  scale_color_manual(values = c("red3", "blue3")) +
  labs(x = "Date", y = "Temp. anom. (°C)") + ggtitle("East Australian Current")

KC.pred <- makePred("KC")

KC <- ggplot(data = KC.pred$predicted, aes(x = date, group = location)) +
  geom_line(data = KC.pred$data, aes(x = date, y = de.seas.corr, colour = location), 
            size = 0.2, show.legend = FALSE) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = "grey70", alpha = 0.7, show.legend = FALSE) +
  geom_hline(aes(yintercept = 0), colour = "black", linetype = "dotted") +
  geom_line(aes(y = incr), colour = "black", size = 0.5) +
  geom_line(aes(y = decr), colour = "black", size = 0.5) +
  facet_grid(location ~ .) +
  scale_color_manual(values = c("red3", "blue3")) +
  labs(x = "Date", y = "Temp. anom. (°C)") + ggtitle("Kuroshio Current")

GS.pred <- makePred("GS")

GS <- ggplot(data = GS.pred$predicted, aes(x = date, group = location)) +
  geom_line(data = GS.pred$data, aes(x = date, y = de.seas.corr, colour = location), 
            size = 0.2, show.legend = FALSE) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = "grey70", alpha = 0.7, show.legend = FALSE) +
  geom_hline(aes(yintercept = 0), colour = "black", linetype = "dotted") +
  geom_line(aes(y = incr), colour = "black", size = 0.5) +
  geom_line(aes(y = decr), colour = "black", size = 0.5) +
  facet_grid(location ~ .) +
  scale_color_manual(values = c("red3", "blue3")) +
  labs(x = "Date", y = "Temp. anom. (°C)") + ggtitle("Gulf Stream")

ggarrange(AC + rremove("x.title") + rremove("y.title"),
          BC + rremove("x.title") + rremove("y.title"),
          EAC + rremove("x.title"), 
          KC + rremove("y.title"),
          GS + rremove("y.title"),
          nrow = 3, ncol = 2,
          align = "hv")
```

